{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "key_ticker": "{{key_ticker}}"
          }
        }
      ],
      "filter": [
        {
          "range": {
            "date_reference": {
              "gte": "{{date_gte}}",
              "lte": "{{date_lte}}",
              "format": "strict_date_optional_time||epoch_millis"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "ad_stats": {
      "scripted_metric": {
        "init_script": "state.entries = new ArrayList();",
        "map_script": "if (doc.containsKey('val_high') && doc['val_high'].size() > 0 && doc['val_high'].value != null && doc.containsKey('val_low') && doc['val_low'].size() > 0 && doc['val_low'].value != null && doc.containsKey('val_close') && doc['val_close'].size() > 0 && doc['val_close'].value != null && doc.containsKey('val_volume') && doc['val_volume'].size() > 0 && doc['val_volume'].value != null && doc.containsKey('date_reference') && doc['date_reference'].size() > 0) { def entry = ['date': doc['date_reference'].value.millis, 'high': doc['val_high'].value, 'low': doc['val_low'].value, 'close': doc['val_close'].value, 'volume': doc['val_volume'].value]; state.entries.add(entry); }",
        "combine_script": "return state.entries;",
        "reduce_script": "def all = []; for (def s : states) { if (s != null) all.addAll(s); } if (all.isEmpty()) return null; all.sort((a,b) -> Long.compare(a.date, b.date)); def results = new ArrayList(); for (int i = 0; i < all.size(); i++) { def high = all[i].high; def low = all[i].low; def close = all[i].close; def volume = all[i].volume; def denom = high - low; def clv = denom != 0 ? ((close - low) - (high - close)) / denom : 0.0; def ad_contrib = clv * volume; def ad_line; def ad_change = null; def position = null; if (i == 0) { ad_line = ad_contrib; } else { def prev_ad_line = results.get(i-1).ad_line; ad_line = prev_ad_line + ad_contrib; ad_change = ad_line - prev_ad_line; position = ad_change > 0 ? 1 : (ad_change < 0 ? -1 : 0); } results.add(['date': all[i].date, 'ad_line': ad_line, 'ad_change': ad_change, 'position': position]); } def formatter = DateTimeFormatter.ofPattern('yyyy-MM-dd').withZone(ZoneId.of('UTC')); def formatted_results = new ArrayList(); for (def res : results) { def date_str = formatter.format(Instant.ofEpochMilli(res.date)); formatted_results.add(['date': date_str, 'ad_line': res.ad_line != null ? Math.round(res.ad_line * 100.0) / 100.0 : null, 'ad_change': res.ad_change != null ? Math.round(res.ad_change * 100.0) / 100.0 : null, 'position': res.position]); } return formatted_results;"
      }
    }
  }
}
