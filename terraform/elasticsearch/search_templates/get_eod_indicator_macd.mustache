{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "key_ticker": "{{key_ticker}}"
          }
        }
      ],
      "filter": [
        {
          "range": {
            "date_reference": {
              "gte": "{{date_gte}}",
              "lte": "{{date_lte}}",
              "format": "strict_date_optional_time||epoch_millis"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "macd_stats": {
      "scripted_metric": {
        "params": {
          "short_window": {{#short_window}}{{short_window}}{{/short_window}}{{^short_window}}7{{/short_window}},
          "long_window": {{#long_window}}{{long_window}}{{/long_window}}{{^long_window}}20{{/long_window}},
          "signal_window": {{#signal_window}}{{signal_window}}{{/signal_window}}{{^signal_window}}6{{/signal_window}}
        },
        "init_script": "state.entries = new ArrayList();",
        "map_script": "if (doc.containsKey('val_close') && doc['val_close'].size() > 0 && doc['val_close'].value != null && doc.containsKey('date_reference') && doc['date_reference'].size() > 0) { def entry = ['date': doc['date_reference'].value.millis, 'close': doc['val_close'].value]; state.entries.add(entry); }",
        "combine_script": "return state.entries;",
        "reduce_script": "def all = []; for (def s : states) { if (s != null) all.addAll(s); } if (all.isEmpty()) return null; all.sort((a,b) -> Long.compare(a.date, b.date)); def short_window = params.short_window; def long_window = params.long_window; def signal_window = params.signal_window; def alpha_short = 2.0 / (short_window + 1.0); def alpha_long = 2.0 / (long_window + 1.0); def alpha_signal = 2.0 / (signal_window + 1.0); def one_minus_alpha_short = 1.0 - alpha_short; def one_minus_alpha_long = 1.0 - alpha_long; def one_minus_alpha_signal = 1.0 - alpha_signal; def n = all.size(); if (n < 2) return []; def short_ema = new double[n]; def long_ema = new double[n]; def macd = new double[n]; def signal = new double[n]; def histogram = new double[n]; short_ema[0] = all[0].close; long_ema[0] = all[0].close; macd[0] = short_ema[0] - long_ema[0]; signal[0] = macd[0]; histogram[0] = macd[0] - signal[0]; def results = new ArrayList(); for (int i = 1; i < n; i++) { short_ema[i] = all[i].close * alpha_short + short_ema[i-1] * one_minus_alpha_short; long_ema[i] = all[i].close * alpha_long + long_ema[i-1] * one_minus_alpha_long; macd[i] = short_ema[i] - long_ema[i]; signal[i] = macd[i] * alpha_signal + signal[i-1] * one_minus_alpha_signal; histogram[i] = macd[i] - signal[i]; def prev_macd = macd[i-1]; def prev_signal = signal[i-1]; def position = (prev_macd < prev_signal && macd[i] > signal[i]) ? 1 : ((prev_macd > prev_signal && macd[i] < signal[i]) ? -1 : 1); results.add(['date': all[i].date, 'short_ema': Math.round(short_ema[i] * 100.0) / 100.0, 'long_ema': Math.round(long_ema[i] * 100.0) / 100.0, 'macd': Math.round(macd[i] * 100.0) / 100.0, 'signal': Math.round(signal[i] * 100.0) / 100.0, 'histogram': Math.round(histogram[i] * 100.0) / 100.0, 'position': position]); } def formatter = DateTimeFormatter.ofPattern('yyyy-MM-dd').withZone(ZoneId.of('UTC')); def formatted_results = new ArrayList(); for (def res : results) { def date_str = formatter.format(Instant.ofEpochMilli(res.date)); formatted_results.add(['date': date_str, 'short_ema': res.short_ema, 'long_ema': res.long_ema, 'macd': res.macd, 'signal': res.signal, 'histogram': res.histogram, 'position': res.position]); } return formatted_results;"
      }
    }
  }
}
