{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "key_ticker": "{{key_ticker}}"
          }
        }
      ],
      "filter": [
        {
          "range": {
            "date_reference": {
              "gte": "{{date_gte}}",
              "lte": "{{date_lte}}",
              "format": "strict_date_optional_time||epoch_millis"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "obv_stats": {
      "scripted_metric": {
        "init_script": "state.entries = new ArrayList();",
        "map_script": "if (doc.containsKey('val_close') && doc['val_close'].size() > 0 && doc['val_close'].value != null && doc.containsKey('val_volume') && doc['val_volume'].size() > 0 && doc['val_volume'].value != null && doc.containsKey('date_reference') && doc['date_reference'].size() > 0) { def entry = ['date': doc['date_reference'].value.millis, 'close': doc['val_close'].value, 'volume': doc['val_volume'].value]; state.entries.add(entry); }",
        "combine_script": "return state.entries;",
        "reduce_script": "def all = []; for (def s : states) { if (s != null) all.addAll(s); } if (all.isEmpty()) return null; all.sort((a,b) -> Long.compare(a.date, b.date)); def n = all.size(); def results = new ArrayList(); if (n < 2) { return []; } def obv = 0.0; for (int i = 1; i < n; i++) { def prev_close = all[i-1].close; def close = all[i].close; def volume = all[i].volume; def close_change = close - prev_close; def signed_volume = close_change > 0 ? volume : (close_change < 0 ? -volume : 0.0); def prev_obv = obv; obv += signed_volume; def obv_change = obv - prev_obv; def position = obv_change > 0 ? 1 : (obv_change < 0 ? -1 : 0); results.add(['date': all[i].date, 'obv': obv, 'obv_change': obv_change, 'position': position]); } def formatter = DateTimeFormatter.ofPattern('yyyy-MM-dd').withZone(ZoneId.of('UTC')); def formatted_results = new ArrayList(); for (def res : results) { def date_str = formatter.format(Instant.ofEpochMilli(res.date)); formatted_results.add(['date': date_str, 'obv': res.obv != null ? Math.round(res.obv * 100.0) / 100.0 : null, 'obv_change': res.obv_change != null ? Math.round(res.obv_change * 100.0) / 100.0 : null, 'position': res.position]); } return formatted_results;"
      }
    }
  }
}
